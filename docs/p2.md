# **¿Qué es una tarea en FreeRTOS?**
Una **tarea** en FreeRTOS es una función independiente que se ejecuta en paralelo con otras tareas. Cada tarea tiene su propio contexto (variables locales, stack, etc.) y puede ser planificada para ejecutarse en un momento determinado por el planificador de FreeRTOS. Las tareas permiten dividir un sistema complejo en módulos más pequeños y manejables.

### **Características principales de las tareas en FreeRTOS:**
1. **Independencia**: Cada tarea opera de manera independiente, lo que facilita la modularidad del código.
2. **Concurrencia**: Varias tareas pueden ejecutarse simultáneamente (aunque en realidad se alternan rápidamente en un solo núcleo).
3. **Prioridades**: Las tareas tienen prioridades asignadas, lo que permite que el planificador determine qué tarea debe ejecutarse primero.
4. **Sincronización**: Las tareas pueden comunicarse entre sí mediante colas, semáforos y otros mecanismos de sincronización.
5. **Bloqueo**: Una tarea puede bloquearse (esperar) hasta que ocurra un evento específico (por ejemplo, recibir datos de una cola).

---

## **Estructura de una tarea en FreeRTOS**
Una tarea en FreeRTOS se define como una función que no retorna (`void`) y recibe un puntero `void*` como parámetro. Este puntero puede usarse para pasar datos iniciales a la tarea.

```cpp
void vTaskFunction(void *pvParameters) {
  // Código de la tarea
  for (;;) { // Bucle infinito
    // Realiza alguna acción
    vTaskDelay(1000 / portTICK_PERIOD_MS); // Pausa la tarea durante 1 segundo
  }
}
```

- **`vTaskFunction`**: Es el nombre de la tarea.
- **`pvParameters`**: Un puntero genérico que puede usarse para pasar datos a la tarea.
- **`for (;;)`**: La mayoría de las tareas tienen un bucle infinito para mantenerse activas.

---

## **Creación de una tarea**
Para crear una tarea en FreeRTOS, se utiliza la función `xTaskCreate()`. Esta función configura y añade una nueva tarea al planificador.

```cpp
xTaskCreate(
  vTaskFunction,      // Función que implementa la tarea
  "TaskName",         // Nombre de la tarea (para depuración)
  STACK_SIZE,         // Tamaño del stack en palabras
  NULL,               // Parámetros pasados a la tarea
  TASK_PRIORITY,      // Prioridad de la tarea
  NULL                // Manejador de la tarea (opcional)
);
```

### **Parámetros de `xTaskCreate`:**
1. **Función de la tarea**: La función que implementa la lógica de la tarea.
2. **Nombre de la tarea**: Un nombre descriptivo para depuración.
3. **Tamaño del stack**: El tamaño del stack asignado a la tarea (en palabras, no bytes).
4. **Parámetros**: Datos opcionales que se pasan a la tarea.
5. **Prioridad**: Un número entero que define la prioridad de la tarea (mayor número = mayor prioridad).
6. **Manejador**: Un puntero opcional para almacenar el identificador de la tarea.

---

## **Planificación de tareas**
FreeRTOS utiliza un **planificador preemptivo** para decidir qué tarea debe ejecutarse en cada momento. El planificador evalúa las prioridades y el estado de las tareas para tomar decisiones.

### **Estados de una tarea**
Cada tarea en FreeRTOS puede estar en uno de los siguientes estados:
1. **Running**: La tarea está siendo ejecutada actualmente.
2. **Ready**: La tarea está lista para ejecutarse pero está esperando su turno.
3. **Blocked**: La tarea está esperando un evento (por ejemplo, recibir datos de una cola).
4. **Suspended**: La tarea ha sido suspendida explícitamente y no se ejecutará hasta que sea reanudada.

---

## **Prioridades de las tareas**
Las tareas en FreeRTOS tienen prioridades numéricas. Cuanto mayor sea el número, mayor será la prioridad. Por ejemplo:
- **Prioridad 1**: Tarea de baja prioridad.
- **Prioridad 10**: Tarea de alta prioridad.

El planificador siempre ejecuta la tarea de mayor prioridad que esté en estado **Ready**. Si dos tareas tienen la misma prioridad, el planificador alterna entre ellas (round-robin).

---

## **Comunicación entre tareas**
En sistemas multitarea, las tareas deben comunicarse entre sí para compartir datos o coordinar acciones. FreeRTOS proporciona varios mecanismos para esto:

1. **Colas**:
   - Permiten el envío de datos entre tareas.
   - Ejemplo: Una tarea envía datos a una cola, y otra tarea los recibe.

   ```cpp
   xQueueSend(xQueueHandle, &data, portMAX_DELAY);
   xQueueReceive(xQueueHandle, &data, portMAX_DELAY);
   ```

2. **Semáforos**:
   - Sincronizan el acceso a recursos compartidos.
   - Tipos: Binarios (mutex), contadores y mutex recursivos.

   ```cpp
   xSemaphoreTake(xSemaphore, portMAX_DELAY);
   xSemaphoreGive(xSemaphore);
   ```

3. **Notificaciones directas**:
   - Permiten enviar señales simples entre tareas sin usar colas o semáforos.

   ```cpp
   xTaskNotifyGive(xTaskHandle);
   ulTaskNotifyTake(pdTRUE, portMAX_DELAY);
   ```

---

## **Gestión del tiempo**
FreeRTOS proporciona funciones para manejar el tiempo dentro de las tareas:

1. **Retardo absoluto**:
   - Pausa la tarea durante un tiempo específico.

   ```cpp
   vTaskDelay(1000 / portTICK_PERIOD_MS); // Retardo de 1 segundo
   ```

2. **Retardo relativo**:
   - Pausa la tarea hasta un tiempo absoluto.

   ```cpp
   TickType_t xLastWakeTime = xTaskGetTickCount();
   vTaskDelayUntil(&xLastWakeTime, 1000 / portTICK_PERIOD_MS);
   ```

---

## **Suspensión y eliminación de tareas**
1. **Suspender una tarea**:
   - Detiene temporalmente la ejecución de una tarea.

   ```cpp
   vTaskSuspend(xTaskHandle);
   ```

2. **Reanudar una tarea**:
   - Reactiva una tarea suspendida.

   ```cpp
   vTaskResume(xTaskHandle);
   ```

3. **Eliminar una tarea**:
   - Libera los recursos asociados a una tarea.

   ```cpp
   vTaskDelete(xTaskHandle);
   ```

---

## **Depuración de tareas**
FreeRTOS incluye herramientas útiles para depurar tareas:

1. **`uxTaskGetStackHighWaterMark()`**:
   - Devuelve la cantidad mínima de stack libre que ha tenido una tarea. Útil para ajustar el tamaño del stack.

   ```cpp
   UBaseType_t uxHighWaterMark = uxTaskGetStackHighWaterMark(NULL);
   ```

2. **`vTaskList()`**:
   - Genera una lista de todas las tareas y sus estados.

   ```cpp
   char pcWriteBuffer[256];
   vTaskList(pcWriteBuffer);
   Serial.println(pcWriteBuffer);
   ```

---

## **Ejemplo completo de tareas en FreeRTOS**
Aquí tienes un ejemplo completo que demuestra cómo crear y gestionar tareas en FreeRTOS:

```cpp
#include <Arduino.h>
#include <freertos/FreeRTOS.h>
#include <freertos/task.h>

// Tarea 1: Imprime "Hola" cada 1 segundo
void TaskHello(void *pvParameters) {
  while (1) {
    Serial.println("Hola");
    vTaskDelay(1000 / portTICK_PERIOD_MS);
  }
}

// Tarea 2: Imprime "Mundo" cada 2 segundos
void TaskWorld(void *pvParameters) {
  while (1) {
    Serial.println("Mundo");
    vTaskDelay(2000 / portTICK_PERIOD_MS);
  }
}

void setup() {
  Serial.begin(115200);

  // Crear las tareas
  xTaskCreate(TaskHello, "HelloTask", 2048, NULL, 1, NULL);
  xTaskCreate(TaskWorld, "WorldTask", 2048, NULL, 1, NULL);
}

void loop() {
  // No hace nada, todo se maneja en las tareas
}
```
